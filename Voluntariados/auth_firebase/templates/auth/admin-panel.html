{% extends "base.html" %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
<div class="columns">
    <!-- Sidebar -->
    <div class="column is-3">
        <div class="box-content">
            <div class="has-text-centered mb-4">
                <h3 class="title is-4 has-text-primary">
                    <i class="fas fa-crown mr-2"></i>Panel Admin
                </h3>
                <p class="subtitle is-6">Gestión de Voluntariados</p>
            </div>
            
            <nav class="menu">
                <p class="menu-label">Administración</p>
                <ul class="menu-list">
                    <li><a href="#voluntariados" class="admin-nav active" data-section="voluntariados">
                        <span class="icon"><i class="fas fa-users"></i></span>
                        Mis Voluntariados
                    </a></li>
                    <li><a href="#eventos" class="admin-nav" data-section="eventos">
                        <span class="icon"><i class="fas fa-calendar-plus"></i></span>
                        Crear Evento
                    </a></li>
                    <li><a href="#miembros" class="admin-nav" data-section="miembros">
                        <span class="icon"><i class="fas fa-user-friends"></i></span>
                        Gestionar Miembros
                    </a></li>
                    <li><a href="#estadisticas" class="admin-nav" data-section="estadisticas">
                        <span class="icon"><i class="fas fa-chart-bar"></i></span>
                        Estadísticas
                    </a></li>
                </ul>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="column is-9">
        <!-- Voluntariados Section -->
        <div id="voluntariados-section" class="admin-section">
            <div class="box-content">
                <h2 class="title is-3 has-text-primary">
                    <i class="fas fa-users mr-3"></i>Mis Voluntariados
                </h2>
                
                <div class="columns is-multiline" id="admin-voluntariados-list">
                    <!-- Se cargarán dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Crear Evento Section -->
        <div id="eventos-section" class="admin-section" style="display: none;">
            <div class="box-content">
                <h2 class="title is-3 has-text-primary">
                    <i class="fas fa-calendar-plus mr-3"></i>Crear Nuevo Evento
                </h2>
                
                <form id="create-event-form" class="box">
                    <div class="field">
                        <label class="label">Voluntariado</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="event-voluntariado" required>
                                    <option value="">Selecciona un voluntariado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Título del Evento</label>
                        <div class="control">
                            <input class="input" type="text" id="event-title" placeholder="Ej: Limpieza del Campus" required>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Descripción</label>
                        <div class="control">
                            <textarea class="textarea" id="event-description" placeholder="Describe el evento..." required></textarea>
                        </div>
                    </div>

                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Fecha y Hora</label>
                                <div class="control">
                                    <input class="input" type="datetime-local" id="event-date" required>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Duración (horas)</label>
                                <div class="control">
                                    <input class="input" type="number" id="event-hours" placeholder="4" min="1" max="12" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Ubicación</label>
                                <div class="control">
                                    <input class="input" type="text" id="event-location" placeholder="UNAH Campus Cortés" required>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">Máximo Participantes</label>
                                <div class="control">
                                    <input class="input" type="number" id="event-max-participants" placeholder="30" min="1" max="100" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Requisitos (opcional)</label>
                        <div class="control">
                            <textarea class="textarea" id="event-requirements" placeholder="Ej: Guantes, botas de trabajo, ropa cómoda"></textarea>
                        </div>
                        <p class="help">Lista los elementos que los participantes deben traer</p>
                    </div>

                    <div class="field">
                        <div class="control">
                            <button class="button is-primary is-fullwidth" type="submit">
                                <span class="icon"><i class="fas fa-calendar-plus"></i></span>
                                <span>Crear Evento</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Gestionar Miembros Section -->
        <div id="miembros-section" class="admin-section" style="display: none;">
            <div class="box-content">
                <h2 class="title is-3 has-text-primary">
                    <i class="fas fa-user-friends mr-3"></i>Gestionar Miembros
                </h2>
                
                <div class="field">
                    <label class="label">Seleccionar Voluntariado</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="members-voluntariado">
                                <option value="">Selecciona un voluntariado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="members-list" style="display: none;">
                    <!-- Se cargarán los miembros dinámicamente -->
                </div>
            </div>
        </div>
        
        <!-- Estadísticas Section -->
        <div id="estadisticas-section" class="admin-section" style="display: none;">
            <div class="box-content">
                <h2 class="title is-3 has-text-primary">
                    <i class="fas fa-chart-bar mr-3"></i>Estadísticas
                </h2>
                
                <div class="columns is-multiline" id="admin-stats">
                    <!-- Se cargarán las estadísticas dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    setupAdminNavigation();
    loadAdminData();
});

function setupAdminNavigation() {
    const navItems = document.querySelectorAll('.admin-nav');
    const sections = document.querySelectorAll('.admin-section');
    
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items
            navItems.forEach(nav => nav.classList.remove('active'));
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Hide all sections
            sections.forEach(section => section.style.display = 'none');
            
            // Show selected section
            const targetSection = this.dataset.section + '-section';
            document.getElementById(targetSection).style.display = 'block';
            
            // Load section data
            loadSectionData(this.dataset.section);
        });
    });
}

async function loadAdminData() {
    try {
        // Verificar permisos de admin
        const isAdmin = await window.adminManager.isUserAdmin();
        if (!isAdmin) {
            window.location.href = '/auth/dashboard/';
            return;
        }

        // Cargar voluntariados del admin
        const adminVoluntariados = await window.adminManager.getAdminVoluntariados();
        
        // Llenar selects con voluntariados
        fillVoluntariadoSelects(adminVoluntariados);
        
        // Mostrar voluntariados en la sección principal
        displayAdminVoluntariados(adminVoluntariados);
        
    } catch (error) {
        console.error('Error cargando datos de admin:', error);
    }
}

function fillVoluntariadoSelects(voluntariados) {
    const eventSelect = document.getElementById('event-voluntariado');
    const membersSelect = document.getElementById('members-voluntariado');
    
    const options = voluntariados.map(vol => 
        `<option value="${vol.id}">${vol.name}</option>`
    ).join('');
    
    eventSelect.innerHTML = '<option value="">Selecciona un voluntariado</option>' + options;
    membersSelect.innerHTML = '<option value="">Selecciona un voluntariado</option>' + options;
}

function displayAdminVoluntariados(voluntariados) {
    const container = document.getElementById('admin-voluntariados-list');
    
    if (voluntariados.length === 0) {
        container.innerHTML = '<p class="has-text-grey">No eres administrador de ningún voluntariado.</p>';
        return;
    }
    
    container.innerHTML = voluntariados.map(vol => `
        <div class="column is-6">
            <div class="card admin-card">
                <div class="card-content">
                    <div class="media">
                        <div class="media-left">
                            <figure class="image is-48x48">
                                <img src="${vol.logo}" alt="${vol.name}">
                            </figure>
                        </div>
                        <div class="media-content">
                            <p class="title is-6">${vol.name}</p>
                            <p class="subtitle is-7 has-text-grey">Código: ${vol.code}</p>
                        </div>
                    </div>
                    <div class="content">
                        <p class="is-small">${vol.description}</p>
                        <div class="level">
                            <div class="level-item has-text-centered">
                                <div>
                                    <p class="heading">Miembros</p>
                                    <p class="title is-6">${vol.memberCount}/${vol.maxMembers}</p>
                                </div>
                            </div>
                            <div class="level-item has-text-centered">
                                <div>
                                    <p class="heading">Estado</p>
                                    <p class="title is-6 has-text-${vol.active ? 'success' : 'danger'}">
                                        ${vol.active ? 'Activo' : 'Inactivo'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadSectionData(section) {
    switch (section) {
        case 'eventos':
            // El formulario ya está listo
            break;
        case 'miembros':
            // Cargar cuando se seleccione un voluntariado
            break;
        case 'estadisticas':
            await loadAdminStats();
            break;
    }
}

// Crear evento
document.getElementById('create-event-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('event-title').value,
        description: document.getElementById('event-description').value,
        date: new Date(document.getElementById('event-date').value),
        location: document.getElementById('event-location').value,
        maxParticipants: parseInt(document.getElementById('event-max-participants').value),
        hours: parseInt(document.getElementById('event-hours').value),
        requirements: document.getElementById('event-requirements').value
    };
    
    const voluntariadoId = document.getElementById('event-voluntariado').value;
    
    try {
        const result = await window.eventsManager.createEvent(voluntariadoId, formData);
        if (result.success) {
            window.authManager.showMessage(result.message, 'success');
            this.reset();
        }
    } catch (error) {
        window.authManager.showMessage(error.message, 'error');
    }
});

// Cargar miembros cuando se seleccione un voluntariado
document.getElementById('members-voluntariado').addEventListener('change', async function() {
    const voluntariadoId = this.value;
    const membersList = document.getElementById('members-list');
    
    if (!voluntariadoId) {
        membersList.style.display = 'none';
        return;
    }
    
    try {
        const members = await window.adminManager.getVoluntariadoMembers(voluntariadoId);
        displayMembers(members);
        membersList.style.display = 'block';
    } catch (error) {
        window.authManager.showMessage(error.message, 'error');
    }
});

function displayMembers(members) {
    const container = document.getElementById('members-list');
    
    if (members.length === 0) {
        container.innerHTML = '<p class="has-text-grey">No hay miembros en este voluntariado.</p>';
        return;
    }
    
    container.innerHTML = `
        <h3 class="title is-5 mb-4">Miembros (${members.length})</h3>
        <div class="columns is-multiline">
            ${members.map(member => `
                <div class="column is-6">
                    <div class="card member-card">
                        <div class="card-content">
                            <div class="media">
                                <div class="media-content">
                                    <p class="title is-6">${member.fullName}</p>
                                    <p class="subtitle is-7 has-text-grey">${member.email}</p>
                                </div>
                            </div>
                            <div class="content">
                                <div class="level">
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">Eventos</p>
                                            <p class="title is-6">${member.voluntariadoData.eventsCompleted || 0}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">Horas</p>
                                            <p class="title is-6">${member.voluntariadoData.totalHours || 0}</p>
                                        </div>
                                    </div>
                                    <div class="level-item has-text-centered">
                                        <div>
                                            <p class="heading">Estado</p>
                                            <p class="title is-6 has-text-${member.voluntariadoData.status === 'activo' ? 'success' : 'danger'}">
                                                ${member.voluntariadoData.status}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

async function loadAdminStats() {
    // Implementar estadísticas del admin
    const container = document.getElementById('admin-stats');
    container.innerHTML = '<p class="has-text-grey">Estadísticas en desarrollo...</p>';
}
</script>

<style>
.admin-nav {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: background-color 0.3s ease;
}

.admin-nav:hover {
    background-color: rgba(41, 137, 216, 0.1);
}

.admin-nav.active {
    background-color: var(--color-primary);
    color: white;
}

.admin-nav .icon {
    margin-right: 0.5rem;
}

.admin-card, .member-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.admin-card:hover, .member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
</style>
{% endblock %}
